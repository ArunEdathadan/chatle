var chatLe=chatLe||{};!function(){"use strict";chatLe=function(){var n={userName:null,chatAPI:null,convAPI:null,userAPI:null,init:null},e=function(n){$("#reasonHidden").val(n),$("#logoutForm").submit()},t=function(){var e=function(e){var t;$.each(this.conversations(),function(n,o){var s=o.attendees();if(2===s.length)for(var i=0;i<s.length;i++){var a=s[i];if(a.UserId===e.Id)return t=o,!1}}),t?t.getMessages():(t=new s({Id:null,Attendees:[{ConversattionId:null,UserId:e.Id},{ConversattionId:null,UserId:n.userName}],Messages:null}),this.conversations.unshift(t)),this.currentConv(t)},t=function(n){if(n){var e;$.each(this.conversations(),function(t,o){return o.id===n.ConversationId?(e=o,!1):void 0}),e&&e.messages.unshift(n)}},o=function(n){n&&(this.conversations.remove(function(e){return e.id===n.Id}),this.conversations.unshift(new s(n)))},i=function(n){this.currentConv(n)};return{userName:null,users:ko.observableArray(),conversations:ko.observableArray(),currentConv:ko.observable(),showMessage:e,messageReceived:t,joinConversation:o,showConversation:i}},o=new t,s=function(t){for(var o=function(t){var o=$(t),s=o.val();o.val("");var i=this;i.id?$.ajax(n.chatAPI,{data:{to:i.id,text:s},type:"POST"}).done(function(){i.messages.unshift({From:n.userName,Text:s})}).fail(function(n){e(n)}):$.ajax(n.convAPI,{data:{to:i.attendees()[0].UserId,text:s},type:"POST"}).done(function(e){i.id=e,i.messages.unshift({From:n.userName,Text:s})}).fail(function(n){e(n)})},s=function(){var t=this;$.getJSON(n.chatAPI+"/"+this.id).done(function(n){t.messages(n)}).fail(function(n){e(n)})},i="",a=t.Attendees,c=0;c<a.length;c++){var r=a[c];r.UserId!==n.userName&&(i+=r.UserId+" ")}return{id:t.Id,title:ko.observable(i),attendees:ko.observableArray(t.Attendees),messages:ko.observableArray(t.Messages),sendMessage:o,getMessages:s}},i=function(t){$.connection.hub.logging=t;var i=$.connection.chat;o.userName=n.userName,ko.applyBindings(o),i.client.userConnected=function(n){console.log("Chat Hub newUserConnected "+n.Id);var e=o.users;e.remove(function(e){return e.Id===n.Id}),e.unshift(n)},i.client.userDisconnected=function(n){console.log("Chat Hub userDisconnected "+n),o.users.remove(function(e){return e.Id===n})},i.client.messageReceived=function(n){o.messageReceived(n)},i.client.joinConversation=function(n){console.log("join conversation "+JSON.stringify(n)),o.joinConversation(n)},$.connection.hub.stateChanged(function(n){var e=null,t=null;for(var o in $.signalR.connectionState)$.signalR.connectionState[o]===n.oldState&&(e=o),$.signalR.connectionState[o]===n.newState&&(t=o);console.log("Chat Hub state changed from "+e+" to "+t)}),$.connection.hub.reconnected(function(){console.log("Chat Hub reconnect")}),$.connection.hub.error(function(n){console.log("Chat Hub error"),e(n)}),$.connection.hub.disconnected(function(){console.log("Chat Hub disconnected"),e("disconnected")}),$.connection.hub.start().done(function(){console.log("Chat Hub started"),$.getJSON(n.userAPI).done(function(n){o.users(n.Users)}).fail(function(n){e(n)}),$.getJSON(n.chatAPI).done(function(n){n&&$.each(n,function(n,e){o.conversations.unshift(new s(e))})}).fail(function(n){e(n)})})};return n.init=i,n}}(),chatLe=chatLe();